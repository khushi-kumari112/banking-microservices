# ================================================
# TRANSACTION SERVICE CONFIGURATION
# ================================================
spring.application.name=transaction-service
server.port=8083

# Application Info (for Actuator)
info.app.name=Transaction Service
info.app.description=Banking Transaction Microservice with Kafka and Redis
info.app.version=1.0.0
info.app.encoding=@project.build.sourceEncoding@
info.app.java.version=@java.version@

# ================================================
# DATABASE CONFIGURATION
# ================================================
spring.datasource.url=jdbc:mysql://localhost:3306/transaction_db?createDatabaseIfNotExist=true&useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Kolkata&useLegacyDatetimeCode=false
spring.datasource.username=root
spring.datasource.password=KHU12@shi
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

# HikariCP Connection Pool (CRITICAL for production)
spring.datasource.hikari.maximum-pool-size=20
spring.datasource.hikari.minimum-idle=5
spring.datasource.hikari.connection-timeout=30000
spring.datasource.hikari.idle-timeout=600000
spring.datasource.hikari.max-lifetime=1800000
spring.datasource.hikari.leak-detection-threshold=60000
spring.datasource.hikari.connection-test-query=SELECT 1

# JPA Configuration
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.format_sql=true
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQLDialect

# JPA Performance Settings
spring.jpa.properties.hibernate.jdbc.batch_size=20
spring.jpa.properties.hibernate.order_inserts=true
spring.jpa.properties.hibernate.order_updates=true
spring.jpa.properties.hibernate.jdbc.batch_versioned_data=true

# Transaction Management
spring.jpa.properties.hibernate.current_session_context_class=org.springframework.orm.hibernate5.SpringSessionContext
spring.jpa.open-in-view=false

# ================================================
# REDIS CONFIGURATION (for Idempotency & Caching)
# ================================================
spring.data.redis.host=localhost
spring.data.redis.port=6379
spring.data.redis.timeout=60000
spring.data.redis.database=0

# Redis Connection Pool
spring.data.redis.jedis.pool.max-active=8
spring.data.redis.jedis.pool.max-idle=8
spring.data.redis.jedis.pool.min-idle=2
spring.data.redis.jedis.pool.max-wait=-1ms

# Cache Configuration
spring.cache.type=redis
spring.cache.redis.time-to-live=600000
spring.cache.redis.cache-null-values=false
spring.cache.redis.key-prefix=transaction:

# Redis Serialization
spring.data.redis.repositories.enabled=false

# ================================================
# KAFKA CONFIGURATION
# ================================================
spring.kafka.bootstrap-servers=localhost:9092

# Producer Configuration (Enhanced for Banking)
spring.kafka.producer.key-serializer=org.apache.kafka.common.serialization.StringSerializer
spring.kafka.producer.value-serializer=org.springframework.kafka.support.serializer.JsonSerializer
spring.kafka.producer.acks=all
spring.kafka.producer.retries=3
spring.kafka.producer.properties.enable.idempotence=true
spring.kafka.producer.properties.max.in.flight.requests.per.connection=5
spring.kafka.producer.properties.compression.type=snappy
spring.kafka.producer.properties.linger.ms=10
spring.kafka.producer.properties.batch.size=16384
spring.kafka.producer.properties.buffer.memory=33554432

# Consumer Configuration
spring.kafka.consumer.group-id=transaction-service-group
spring.kafka.consumer.auto-offset-reset=earliest
spring.kafka.consumer.key-deserializer=org.apache.kafka.common.serialization.StringDeserializer
spring.kafka.consumer.value-deserializer=org.springframework.kafka.support.serializer.JsonDeserializer
spring.kafka.consumer.properties.spring.json.trusted.packages=*
spring.kafka.consumer.enable-auto-commit=false
spring.kafka.listener.ack-mode=manual

# Kafka Topics
kafka.topics.transaction-completed=transaction-completed-topic
kafka.topics.transaction-failed=transaction-failed-topic
kafka.topics.transaction-reversed=transaction-reversed-topic

# ================================================
# FEIGN CLIENT CONFIGURATION
# ================================================
# Account Service URL (CRITICAL - Must Match Account Service Port)
account.service.url=http://localhost:8082

# User Service URL (For Future Use)
user.service.url=http://localhost:8081

# Account Service Specific Config
feign.client.config.account-service.connect-timeout=5000
feign.client.config.account-service.read-timeout=10000
feign.client.config.account-service.logger-level=full

# Default Feign Configuration (Fallback for all clients)
feign.client.config.default.connect-timeout=5000
feign.client.config.default.read-timeout=10000
feign.client.config.default.logger-level=basic
feign.client.config.default.retryer=feign.Retryer.Default

# Enable Feign Circuit Breaker Integration
feign.circuitbreaker.enabled=true
feign.circuitbreaker.alphanumeric-ids.enabled=true

# ================================================
# TRANSACTION LIMITS (Real Banking Limits)
# ================================================
# Daily transaction limit per account (?1,00,000)
transaction.limit.daily=100000

# Per transaction limit (?50,000)
transaction.limit.per-transaction=50000

# Large amount threshold for additional verification (?10,000)
transaction.limit.large-amount-threshold=10000

# Transfer Methods Configuration
transaction.transfer.imps.enabled=true
transaction.transfer.neft.enabled=true
transaction.transfer.rtgs.enabled=true

# RTGS minimum amount (?2,00,000)
transaction.transfer.rtgs.min-amount=200000

# Idempotency TTL (in seconds) - 24 hours
transaction.idempotency-ttl=86400

# ================================================
# RESILIENCE4J CIRCUIT BREAKER
# ================================================
# Circuit Breaker for Account Service
resilience4j.circuitbreaker.instances.account-service.register-health-indicator=true
resilience4j.circuitbreaker.instances.account-service.sliding-window-type=COUNT_BASED
resilience4j.circuitbreaker.instances.account-service.sliding-window-size=10
resilience4j.circuitbreaker.instances.account-service.minimum-number-of-calls=5
resilience4j.circuitbreaker.instances.account-service.permitted-number-of-calls-in-half-open-state=3
resilience4j.circuitbreaker.instances.account-service.wait-duration-in-open-state=10s
resilience4j.circuitbreaker.instances.account-service.failure-rate-threshold=50
resilience4j.circuitbreaker.instances.account-service.slow-call-rate-threshold=50
resilience4j.circuitbreaker.instances.account-service.slow-call-duration-threshold=2s
resilience4j.circuitbreaker.instances.account-service.automatic-transition-from-open-to-half-open-enabled=true

# Retry Configuration for Account Service
resilience4j.retry.instances.account-service.max-attempts=3
resilience4j.retry.instances.account-service.wait-duration=500ms
resilience4j.retry.instances.account-service.enable-exponential-backoff=true
resilience4j.retry.instances.account-service.exponential-backoff-multiplier=2
resilience4j.retry.instances.account-service.retry-exceptions=java.net.ConnectException,org.springframework.web.client.ResourceAccessException,feign.RetryableException

# Rate Limiter (CRITICAL for banking - prevents abuse)
resilience4j.ratelimiter.instances.account-service.limit-for-period=100
resilience4j.ratelimiter.instances.account-service.limit-refresh-period=1s
resilience4j.ratelimiter.instances.account-service.timeout-duration=0s

# Bulkhead (Thread pool isolation)
resilience4j.bulkhead.instances.account-service.max-concurrent-calls=10
resilience4j.bulkhead.instances.account-service.max-wait-duration=100ms

# Time Limiter (Request timeout)
resilience4j.timelimiter.instances.account-service.timeout-duration=3s
resilience4j.timelimiter.instances.account-service.cancel-running-future=true

# ================================================
# JWT CONFIGURATION (MUST MATCH USER SERVICE)
# ================================================
jwt.secret=5367566B59703373367639792F423F4528482B4D6251655468576D5A71347437
jwt.expiration=86400000
jwt.issuer=banking-user-service
# ================================================
# LOGGING CONFIGURATION
# ================================================
logging.level.root=INFO
logging.level.com.banking.transaction_service=DEBUG
logging.level.org.springframework.kafka=INFO
logging.level.org.springframework.data.redis=INFO
logging.level.org.springframework.cloud.openfeign=DEBUG
logging.level.feign=DEBUG
logging.level.org.hibernate.SQL=DEBUG
logging.level.org.hibernate.type.descriptor.sql.BasicBinder=TRACE

# Log Pattern
logging.pattern.console=%d{yyyy-MM-dd HH:mm:ss} - %msg%n
logging.pattern.file=%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n

# Log File Configuration
logging.file.name=logs/transaction-service.log
logging.file.max-size=10MB
logging.file.max-history=30

# ================================================
# ACTUATOR CONFIGURATION (Enhanced Monitoring)
# ================================================
management.endpoints.web.exposure.include=health,info,metrics,prometheus,circuitbreakers,circuitbreakerevents,ratelimiters,bulkheads,retries
management.endpoints.web.base-path=/actuator
management.endpoint.health.show-details=always
management.endpoint.health.show-components=always

# Health Indicators
management.health.circuitbreakers.enabled=true
management.health.ratelimiters.enabled=true
management.health.redis.enabled=true
management.health.db.enabled=true
management.health.diskspace.enabled=true

# Metrics Configuration
management.metrics.export.prometheus.enabled=true
management.metrics.distribution.percentiles-histogram.http.server.requests=true
management.metrics.tags.application=${spring.application.name}
management.metrics.tags.environment=production

# ================================================
# SECURITY CONFIGURATION
# ================================================
spring.security.enabled=true

# ================================================
# CORS CONFIGURATION (API Gateway Integration)
# ================================================
spring.web.cors.allowed-origins=http://localhost:3000,http://localhost:8080
spring.web.cors.allowed-methods=GET,POST,PUT,DELETE,OPTIONS
spring.web.cors.allowed-headers=Authorization,Content-Type,X-User-Id,X-Username
spring.web.cors.exposed-headers=Authorization,X-Total-Count
spring.web.cors.allow-credentials=true
spring.web.cors.max-age=3600

# ================================================
# ERROR HANDLING CONFIGURATION
# ================================================
server.error.include-message=always
server.error.include-binding-errors=always
server.error.include-stacktrace=on_param
server.error.include-exception=false
spring.mvc.problemdetails.enabled=true

# ================================================
# JACKSON JSON CONFIGURATION
# ================================================
spring.jackson.serialization.fail-on-empty-beans=false
spring.jackson.serialization.write-dates-as-timestamps=false
spring.jackson.serialization.indent-output=true
spring.jackson.serialization.write-bigdecimal-as-plain=true
spring.jackson.deserialization.fail-on-unknown-properties=false
spring.jackson.deserialization.use-big-decimal-for-floats=true
spring.jackson.time-zone=Asia/Kolkata
spring.jackson.date-format=yyyy-MM-dd'T'HH:mm:ss
spring.jackson.default-property-inclusion=non_null

# ================================================
# TRANSACTION TIMEOUT CONFIGURATION (CRITICAL)
# ================================================
spring.transaction.default-timeout=30
spring.jpa.properties.hibernate.transaction.timeout=30

# ================================================
# SERVER CONFIGURATION
# ================================================
server.compression.enabled=true
server.compression.mime-types=application/json,application/xml,text/html,text/xml,text/plain
server.compression.min-response-size=1024

# Tomcat Configuration
server.tomcat.max-threads=200
server.tomcat.min-spare-threads=10
server.tomcat.max-connections=10000
server.tomcat.accept-count=100
server.tomcat.connection-timeout=20000

# Request Size Limits (Security)
spring.servlet.multipart.max-file-size=1MB
spring.servlet.multipart.max-request-size=1MB
server.tomcat.max-swallow-size=1MB
server.max-http-request-header-size=8KB

# ================================================
# SPRING BOOT CONFIGURATION
# ================================================
spring.main.allow-bean-definition-overriding=true
spring.main.banner-mode=console
spring.output.ansi.enabled=always

# ================================================
# API DOCUMENTATION (SpringDoc OpenAPI)
# ================================================
springdoc.api-docs.enabled=true
springdoc.api-docs.path=/api-docs
springdoc.swagger-ui.enabled=true
springdoc.swagger-ui.path=/swagger-ui.html
springdoc.swagger-ui.operations-sorter=method

# ================================================
# PROFILE-SPECIFIC CONFIGURATION
# ================================================
spring.profiles.active=dev

# ================================================
# ASYNC CONFIGURATION
# ================================================
spring.task.execution.pool.core-size=5
spring.task.execution.pool.max-size=10
spring.task.execution.pool.queue-capacity=100
spring.task.execution.thread-name-prefix=transaction-async-

